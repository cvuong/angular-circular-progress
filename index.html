<!doctype html>
<html ng-app="demoApp">
  <head>
    <title>Angular Circular Progress Demo</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>
  <body>
    <circular-progress actual="0.45" expected="0.15"></circular-progress>
  </body>
  <script>
    (function() {
      var demoApp = angular.module('demoApp', []);

      // TODO: Use a templateUrl
      demoApp.directive('circularProgress', function() {
        return {
          restrict: 'E',
          template: '<div class="circular-progress"></div>',
          link: function(scope, elem, attr) {
            // Color constants
            var COLORS = {
              GREEN: 'green',
              ORANGE: 'orange',
              RED: 'red',
              GREY: '#EEEEEE'
            };

            // Return a float between 0 to 1.0 as a string with a percent
            // (i.e., 0.4567 -> "45%"), we always truncate to two digits.
            function getPctString(num) {
              return (num * 100)
            }

            // Converts a float between 0 to 1.0 into a radians value between
            // 0 to 2PI.
            function convertPctToRadians(num) {
              return num * (2 * Math.PI)
            }

            // Returns the color value of the actual progress arc when passed
            // in an actual progress angle and an expected progress angle.
            function getActualProgressEndColor(actualAngle, expectedAngle) {
              var diffAngle = actualProgressAngle - expectedProgressAngle;

              if ((diffAngle < -25) && (diffAngle >= -50)) {
                return COLORS.ORANGE
              } else if (diffAngle < -50) {
                return COLORS.RED
              } else {
                return COLORS.DARK_GREEN
              }


            }

            // Size constants
            var RADIUS = 100,
                ACTUAL_PROGRESS_THICKNESS = 5, // px
                ACTUAL_PROGRESS_OUTER_RADIUS = RADIUS, // px
                ACTUAL_PROGRESS_INNER_RADIUS = ACTUAL_PROGRESS_OUTER_RADIUS - ACTUAL_PROGRESS_THICKNESS, // px
                PROGRESS_SPACING = 3, // px
                CIRCLE_MARGIN = 5, // px
                EXPECTED_PROGRESS_THICKNESS = 5, // px
                EXPECTED_PROGRESS_OUTER_RADIUS = ACTUAL_PROGRESS_INNER_RADIUS - PROGRESS_SPACING, // px
                EXPECTED_PROGRESS_INNER_RADIUS = EXPECTED_PROGRESS_OUTER_RADIUS - EXPECTED_PROGRESS_THICKNESS, // px
                CIRCLE_RADIUS = EXPECTED_PROGRESS_INNER_RADIUS - CIRCLE_MARGIN; // px

            // Class constant
            var PROGRESS_CLASS = '.circular-progress';

            // Render the SVG container element
            var svg = d3.select(PROGRESS_CLASS)
              .append('svg')
              .attr('width', RADIUS * 2)
              .attr('height', RADIUS * 2)
              .append('g')
              .attr('transform', 'translate(' + RADIUS + ', ' + RADIUS + ')');

              // Render the actual progress arc
              var actualProgressArc = d3.arc()
                .outerRadius(ACTUAL_PROGRESS_OUTER_RADIUS)
                .innerRadius(ACTUAL_PROGRESS_INNER_RADIUS)
                .startAngle(0);

              // Render the expected progress arc
              var expectedProgressArc = d3.arc()
                .outerRadius(EXPECTED_PROGRESS_OUTER_RADIUS)
                .innerRadius(EXPECTED_PROGRESS_INNER_RADIUS)
                .startAngle(0)

              // Append the actual progress ring
              var actualProgressRing = svg.append('path')
                .datum({endAngle: 0})
                .attr('class', 'arc')
                .style('fill', COLORS.GREEN)
                .attr('d', actualProgressArc);

              // Append the expected progress ring
              var expectedProgressRing = svg.append('path')
                .datum({endAngle: 0})
                .attr('class', 'arc')
                .style('fill', COLORS.GREEN)
                .attr('d', expectedProgressArc);

              // Append the inner circle
              svg.append('circle')
                .attr('r', CIRCLE_RADIUS)
                .style('fill', COLORS.GREY);

              // Append the inner circle text
              var actualProgress = getPctString(attr.actual);
              svg.append('text')
                .text(actualProgress)
                .attr('x', '-8px')
                .attr('font-family', 'Helvetica')
                .attr('font-size', '42px')
                .style('fill', '#555555')
                .attr('text-anchor', 'middle')
                .attr('alignment-baseline', 'center')

                // Append the percentage
                svg.append('text')
                  .text('%')
                  .attr('x', '26px')
                  .attr('font-family', 'Helvetica')
                  .attr('font-size', '24px')
                  .attr('fill', '#555555')
                  .attr('text-anchor', 'middle')
                  .attr('alignment-baseline', 'center')

                // Append the progress label
                svg.append('text')
                  .text('Progress')
                  .attr('y', '20px')
                  .attr('font-family', 'Helvetica')
                  .attr('font-size', '16px')
                  .attr('fill', '#555555')
                  .attr('text-anchor', 'middle')
                  .attr('alignment-baseline', 'center')

              actualProgressRing.transition()
                .attr('fill', 'red');

              // Transition the arc
              // https://bl.ocks.org/mbostock/5100636
              setTimeout(function() {
                var actualProgressAngle = convertPctToRadians(attr.actual);
                var expectedProgressAngle = convertPctToRadians(attr.expected);
                var diffAngle = actualProgressAngle - expectedProgressAngle;

                var actualProgressEndColor;

                actualProgressRing.transition()
                  .duration(1000)
                  .style('fill', 'red')
                  .call(arcTweenActual, actualProgressAngle);
                expectedProgressRing.transition()
                  .duration(1000)
                  .call(arcTweenExpected, expectedProgressAngle);
              }, 100);

              function arcTweenActual(transition, newAngle) {
                transition.attrTween('d', function(d) {
                  var interpolate = d3.interpolate(d.endAngle, newAngle);
                  return function(t) {
                    d.endAngle = interpolate(t);
                    return actualProgressArc(d)
                  }
                });
              }

              function arcTweenExpected(transition, newAngle) {
                transition.attrTween('d', function(d) {
                  var interpolate = d3.interpolate(d.endAngle, newAngle);
                  return function(t) {
                    d.endAngle = interpolate(t);
                    return expectedProgressArc(d)
                  }
                });
              }

          }
        }
      });
    })()
  </script>
</html>
